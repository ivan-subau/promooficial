<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - Gesti√≥n de Ingreso</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #4f46e5;
      --bg-body: #f3f4f6;
      --text-main: #1f2937;
      --border: #e5e7eb;
      --success: #10b981;
    }

    * { box-sizing: border-box; }
    body { font-family: 'Inter', sans-serif; background-color: var(--bg-body); color: var(--text-main); margin: 0; padding: 2rem; }

    /* --- ESTILOS DE PANTALLA --- */
    .screen-only { display: block; }
    
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { color: var(--primary); margin-bottom: 1.5rem; }

    /* Stats */
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .stat-card { background: white; padding: 1.5rem; border-radius: 12px; border-left: 5px solid var(--primary); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .stat-value { font-size: 2rem; font-weight: 700; }
    
    /* Panel Acciones */
    .action-panel { background: white; padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .controls-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; align-items: end; }
    
    input, select { width: 100%; padding: 0.6rem; border: 1px solid var(--border); border-radius: 6px; margin-top: 5px; }
    
    /* Botones */
    button { padding: 0.6rem 1.2rem; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; background: var(--primary); color: white; transition: 0.2s; }
    button:hover { background: #3730a3; }
    .btn-outline { background: transparent; border: 1px solid var(--primary); color: var(--primary); }
    .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.85rem; }
    .btn-success { background-color: var(--success); color: white; }
    .btn-success:hover { background-color: #059669; }

    /* Tabla Pantalla */
    .table-responsive { overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    table.screen-table { width: 100%; border-collapse: collapse; }
    table.screen-table th { background: var(--primary); color: white; padding: 1rem; text-align: left; }
    table.screen-table td { padding: 1rem; border-bottom: 1px solid var(--border); }
    .badge-mesa { background: #e0e7ff; color: #3730a3; padding: 2px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; margin: 2px; display: inline-block; }

    /* Modal Generico */
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-overlay.active { display: flex; }
    .modal-content { background: white; width: 90%; max-width: 650px; padding: 2rem; border-radius: 12px; max-height: 90vh; overflow-y: auto; position: relative; }
    .mesa-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 0.5rem; border: 1px solid var(--border); padding: 0.5rem; border-radius: 6px; max-height: 150px; overflow-y: auto; }

    /* --- ESTILOS DE IMPRESI√ìN (SOLUCI√ìN 1 y 2) --- */
    #print-area { display: none; }

    @media print {
      /* Ocultar elementos de UI */
      .screen-only, .modal-overlay { display: none !important; }
      
      /* Configuraci√≥n de P√°gina */
      @page { margin: 0; size: auto; } /* Borra fecha/url */
      body { margin: 1.5cm; background: white; font-family: Arial, sans-serif; }

      #print-area { display: block; width: 100%; }
      
      /* Cabecera Ticket */
      .print-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
      .print-header h2 { margin: 0; font-size: 18px; text-transform: uppercase; }
      .print-header p { margin: 5px 0 0 0; font-size: 12px; }

      /* Tabla Checklist */
      table.print-table { width: 100%; border-collapse: collapse; }
      
      /* SOLUCI√ìN 2: Repetir Encabezados */
      thead { display: table-header-group; } 
      
      table.print-table th { border: 1px solid #000; background-color: #f0f0f0; padding: 8px; font-size: 11px; text-transform: uppercase; }
      
      /* SOLUCI√ìN 1: Evitar Ruptura Interna */
      table.print-table tr { page-break-inside: avoid; break-inside: avoid; }
      
      table.print-table td { border: 1px solid #000; padding: 8px; vertical-align: middle; }
      
      /* Columnas */
      .col-check { width: 40px; text-align: center; }
      .check-box { width: 15px; height: 15px; border: 2px solid #000; display: inline-block; }
      
      .col-data { text-align: left; }
      .print-alumno { font-size: 14px; font-weight: bold; display: block; text-transform: uppercase;}
      .print-acomp-list { font-size: 12px; color: #333; margin-top: 4px; padding-left: 15px; }
      .print-acomp-item::before { content: "‚Ü≥ "; font-weight: bold; }
      
      .col-mesa { width: 130px; text-align: center; font-weight: bold; font-size: 16px; }
      
      .print-footer { margin-top: 20px; text-align: right; font-size: 10px; border-top: 1px dashed #000; padding-top: 5px; }
    }
  </style>
</head>
<body>

<div class="container screen-only">
  <h1>Panel de Administraci√≥n</h1>

  <section class="stats-grid">
    <div class="stat-card">
      <div class="stat-value" id="stat-alumnos">0</div>
      <div style="color:#666; font-size:0.9rem;">ALUMNOS</div>
    </div>
    <div class="stat-card" style="border-left-color: #10b981;">
      <div class="stat-value" id="stat-total">0</div>
      <div style="color:#666; font-size:0.9rem;">ASISTENTES (TOTAL)</div>
    </div>
    <div class="stat-card" style="border-left-color: #f59e0b;">
      <div class="stat-value" id="stat-mesas">0</div>
      <div style="color:#666; font-size:0.9rem;">MESAS OCUPADAS</div>
    </div>
  </section>

  <section class="action-panel">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; flex-wrap:wrap; gap:10px;">
      <h3>Gesti√≥n de Ingreso</h3>
      <div>
        <button class="btn-success" onclick="abrirModalNuevoAlumno()">+ üë§ Nuevo Alumno</button>
        <button onclick="prepararImpresion()">üñ®Ô∏è Imprimir Reporte</button>
      </div>
    </div>

    <div style="background:#f9fafb; padding:1rem; border:1px dashed #ccc; border-radius:6px; margin-bottom:1rem;">
       <small style="font-weight:bold; color:var(--primary);">CONFIGURACI√ìN R√ÅPIDA:</small>
       <div class="controls-grid">
         <div>
            <input type="text" id="new-local" placeholder="Nuevo Local">
            <button class="btn-sm" onclick="addLocal()">Crear Local</button>
         </div>
         <div>
            <input type="text" id="new-mesa" placeholder="Nueva Mesa (Ej: Mesa 1)">
            <button class="btn-sm btn-outline" onclick="addMesa()">Crear Mesa</button>
         </div>
         <div>
           <div style="display:flex; gap:5px;">
             <input type="text" id="new-inst" placeholder="Nueva Instituci√≥n">
             <button class="btn-sm" onclick="addInst()">Crear Inst. (Usa filtro local)</button>
           </div>
         </div>
       </div>
    </div>

    <div class="controls-grid">
      <div>
        <label>Local:</label>
        <select id="filtro-local" onchange="cargarInstFiltro()"><option value="">Todos</option></select>
      </div>
      <div>
        <label>Instituci√≥n:</label>
        <select id="filtro-inst" disabled onchange="filtrarDatos()"><option value="">Todas</option></select>
      </div>
      <div>
        <label>Buscar:</label>
        <input type="text" id="filtro-texto" placeholder="Nombre alumno..." onkeyup="filtrarDatos()">
      </div>
    </div>
  </section>

  <div class="table-responsive">
    <table class="screen-table">
      <thead>
        <tr>
          <th>Local / Instituci√≥n</th>
          <th>Alumno</th>
          <th>Acompa√±antes</th>
          <th>Mesas</th>
          <th>Acci√≥n</th>
        </tr>
      </thead>
      <tbody id="tabla-body"></tbody>
    </table>
  </div>
</div>

<div id="print-area">
  <div class="print-header">
    <h2>LISTA DE CONTROL DE INGRESO</h2>
    <p id="print-subtitle"></p>
  </div>
  <table class="print-table">
    <thead>
      <tr>
        <th class="col-check">CHECK</th>
        <th class="col-data">ASISTENTES (GRUPO FAMILIAR)</th>
        <th class="col-mesa">UBICACI√ìN</th>
      </tr>
    </thead>
    <tbody id="print-tbody"></tbody>
  </table>
  <div class="print-footer">Generado el <span id="print-date"></span></div>
</div>

<div class="modal-overlay" id="modal-editar">
  <div class="modal-content">
    <span style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:20px;" onclick="closeModal('modal-editar')">√ó</span>
    <h3 style="margin-top:0;">Editar Asistente</h3>
    <input type="hidden" id="edit-id">
    
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
      <div><label>Nombre</label><input type="text" id="edit-nom"></div>
      <div><label>Apellido</label><input type="text" id="edit-ape"></div>
    </div>

    <label><strong>Mesas:</strong></label>
    <div class="mesa-grid" id="edit-mesas-container"></div>
    
    <label style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
        <strong>Acompa√±antes:</strong>
        <button class="btn-sm btn-outline" onclick="agregarFilaAcompEditar()">+ Agregar otro</button>
    </label>
    <div id="edit-acomp-container"></div>

    <div style="margin-top:20px; text-align:right;">
      <button class="btn-outline" onclick="closeModal('modal-editar')">Cancelar</button>
      <button onclick="guardarEdicion()">Guardar Cambios</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="modal-nuevo">
  <div class="modal-content">
    <span style="position:absolute; top:10px; right:15px; cursor:pointer; font-size:20px;" onclick="closeModal('modal-nuevo')">√ó</span>
    <h3 style="margin-top:0; color:var(--success);">Registrar Nuevo Alumno</h3>
    
    <div class="controls-grid" style="margin-bottom:15px;">
        <div>
            <label>1. Local</label>
            <select id="new-al-local" onchange="cargarInstNuevoAlumno()"><option value="">Selecciona...</option></select>
        </div>
        <div>
            <label>2. Instituci√≥n</label>
            <select id="new-al-inst" disabled><option value="">Selecciona Local...</option></select>
        </div>
    </div>

    <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
        <div><label>Nombre Alumno</label><input type="text" id="new-al-nom"></div>
        <div><label>Apellido Alumno</label><input type="text" id="new-al-ape"></div>
    </div>

    <label><strong>Asignar Mesas (Opcional):</strong></label>
    <div class="mesa-grid" id="new-al-mesas"></div>

    <label style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
        <strong>Acompa√±antes:</strong>
        <button class="btn-sm btn-outline" onclick="agregarFilaAcompNuevo()">+ Agregar</button>
    </label>
    <div id="new-al-acomp-container" style="border:1px dashed #ccc; padding:10px; border-radius:6px; min-height:50px;"></div>

    <div style="margin-top:20px; text-align:right;">
        <button class="btn-outline" onclick="closeModal('modal-nuevo')">Cancelar</button>
        <button class="btn-success" onclick="guardarNuevoAlumno()">Registrar Alumno</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL = 'https://zygyagsmkjgvtmoxoznk.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5Z3lhZ3Nta2pndnRtb3hvem5rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0ODk3OTMsImV4cCI6MjA3OTA2NTc5M30.ZQ2ihigMNlbR5DtWcaiOxDUYdImkd7Af-xcpjHV8LnY';
const { createClient } = window.supabase;
const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let dataGlobal = [];
let mesasGlobal = [];
let localesGlobal = [];

const tBody = document.getElementById('tabla-body');
const selLocal = document.getElementById('filtro-local');
const selInst = document.getElementById('filtro-inst');
const inpText = document.getElementById('filtro-texto');

init();

async function init() {
  await Promise.all([cargarLocales(), cargarMesas()]);
  await cargarDatos();
}

async function cargarLocales() {
  const { data } = await supabase.from('locales').select('*').order('nombre');
  localesGlobal = data || [];
  selLocal.innerHTML = '<option value="">Todos los Locales</option>';
  localesGlobal.forEach(l => selLocal.innerHTML += `<option value="${l.id}">${l.nombre}</option>`);
}
async function cargarMesas() {
  const { data } = await supabase.from('mesas').select('*').order('nombre');
  mesasGlobal = data || [];
}

async function cargarDatos() {
  tBody.innerHTML = '<tr><td colspan="5" style="text-align:center">Cargando datos...</td></tr>';
  const { data, error } = await supabase.from('alumnos').select(`
    id, nombre, apellido, institucion_id,
    institucion:instituciones_educativas(id, nombre, local_id, local:locales(nombre)),
    acompanantes(id, nombre, apellido),
    alumno_mesas(mesa:mesas(id, nombre))
  `).order('id', {ascending:false});
  
  if(error) return alert('Error cargando datos');
  dataGlobal = data || [];
  filtrarDatos();
}

async function cargarInstFiltro() {
  const locId = selLocal.value;
  selInst.innerHTML = '<option value="">Todas</option>';
  selInst.disabled = !locId;
  if(locId) {
    const { data } = await supabase.from('instituciones_educativas').select('*').eq('local_id', locId);
    data.forEach(i => selInst.innerHTML += `<option value="${i.id}">${i.nombre}</option>`);
  }
  filtrarDatos();
}

function filtrarDatos() {
  const loc = selLocal.value;
  const inst = selInst.value;
  const txt = inpText.value.toLowerCase();
  const filtrados = dataGlobal.filter(d => {
    const matchLoc = loc ? d.institucion?.local_id == loc : true;
    const matchInst = inst ? d.institucion?.id == inst : true;
    const matchTxt = (d.nombre+' '+d.apellido).toLowerCase().includes(txt);
    return matchLoc && matchInst && matchTxt;
  });
  renderPantalla(filtrados);
  updateStats(filtrados);
}

function renderPantalla(datos) {
  tBody.innerHTML = '';
  if(datos.length === 0) return tBody.innerHTML = '<tr><td colspan="5" style="text-align:center">Sin datos</td></tr>';
  datos.forEach(d => {
    const mesas = d.alumno_mesas.map(m => `<span class="badge-mesa">${m.mesa?.nombre}</span>`).join(' ');
    const acomps = d.acompanantes.map(a => `<div>‚Ä¢ ${a.nombre} ${a.apellido}</div>`).join('');
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><strong>${d.institucion?.local?.nombre || '-'}</strong><br><small>${d.institucion?.nombre || ''}</small></td>
      <td>${d.nombre} ${d.apellido}</td>
      <td style="font-size:0.85rem; color:#555;">${acomps || 'Sin acompa√±antes'}</td>
      <td>${mesas || '<span style="color:#ccc">---</span>'}</td>
      <td><button class="btn-sm btn-outline" onclick="abrirModalEditar(${d.id})">‚úèÔ∏è Editar</button></td>
    `;
    tBody.appendChild(tr);
  });
}

function updateStats(datos) {
  document.getElementById('stat-alumnos').textContent = datos.length;
  const totalAcomp = datos.reduce((acc, d) => acc + d.acompanantes.length, 0);
  document.getElementById('stat-total').textContent = datos.length + totalAcomp;
  const totalMesas = datos.reduce((acc, d) => acc + d.alumno_mesas.length, 0);
  document.getElementById('stat-mesas').textContent = totalMesas;
}

// --- IMPRESI√ìN ---
function prepararImpresion() {
  const loc = selLocal.value;
  const inst = selInst.value;
  const txt = inpText.value.toLowerCase();
  
  const datosPrint = dataGlobal.filter(d => {
    const matchLoc = loc ? d.institucion?.local_id == loc : true;
    const matchInst = inst ? d.institucion?.id == inst : true;
    const matchTxt = (d.nombre+' '+d.apellido).toLowerCase().includes(txt);
    return matchLoc && matchInst && matchTxt;
  });

  const localNombre = loc ? selLocal.options[selLocal.selectedIndex].text : "TODOS";
  const instNombre = inst ? selInst.options[selInst.selectedIndex].text : "VARIAS";
  document.getElementById('print-subtitle').innerHTML = `<strong>LOCAL:</strong> ${localNombre} | <strong>INST:</strong> ${instNombre}`;
  document.getElementById('print-date').textContent = new Date().toLocaleString();

  const tbody = document.getElementById('print-tbody');
  tbody.innerHTML = '';
  datosPrint.forEach((d, idx) => {
    let acompHTML = '<div class="print-acomp-list">';
    if(d.acompanantes.length) d.acompanantes.forEach(a => acompHTML += `<div class="print-acomp-item">${a.nombre} ${a.apellido}</div>`);
    else acompHTML += `<em style="color:#999; font-size:11px;">(Sin acompa√±antes)</em>`;
    acompHTML += '</div>';

    let mesaHTML = d.alumno_mesas.length ? d.alumno_mesas.map(m => m.mesa?.nombre).join(' / ') : '';
    
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td class="col-check"><div class="check-box"></div></td>
      <td class="col-data">
        <span class="print-alumno">${idx+1}. ${d.nombre} ${d.apellido}</span>
        ${acompHTML}
      </td>
      <td class="col-mesa">${mesaHTML}</td>
    `;
    tbody.appendChild(tr);
  });
  window.print();
}

// --- MODAL NUEVO ALUMNO ---
function abrirModalNuevoAlumno() {
  // Llenar select locales
  const sel = document.getElementById('new-al-local');
  sel.innerHTML = '<option value="">Selecciona Local...</option>';
  localesGlobal.forEach(l => sel.innerHTML += `<option value="${l.id}">${l.nombre}</option>`);
  
  // Resetear campos
  document.getElementById('new-al-inst').innerHTML = '<option value="">Selecciona Local...</option>';
  document.getElementById('new-al-inst').disabled = true;
  document.getElementById('new-al-nom').value = '';
  document.getElementById('new-al-ape').value = '';
  document.getElementById('new-al-acomp-container').innerHTML = '';
  
  // Checkboxes mesas
  const divMesas = document.getElementById('new-al-mesas');
  divMesas.innerHTML = '';
  mesasGlobal.forEach(m => {
    divMesas.innerHTML += `<label style="display:flex; gap:5px; align-items:center; font-size:0.9rem;"><input type="checkbox" value="${m.id}"> ${m.nombre}</label>`;
  });

  document.getElementById('modal-nuevo').classList.add('active');
}

async function cargarInstNuevoAlumno() {
  const locId = document.getElementById('new-al-local').value;
  const selInst = document.getElementById('new-al-inst');
  selInst.innerHTML = '<option value="">Cargando...</option>';
  selInst.disabled = true;
  if(locId) {
    const { data } = await supabase.from('instituciones_educativas').select('*').eq('local_id', locId);
    selInst.innerHTML = '<option value="">Selecciona Instituci√≥n...</option>';
    data.forEach(i => selInst.innerHTML += `<option value="${i.id}">${i.nombre}</option>`);
    selInst.disabled = false;
  }
}

function agregarFilaAcompNuevo() {
  const div = document.createElement('div');
  div.style.display = 'flex'; div.style.gap = '5px'; div.style.marginBottom = '5px';
  div.innerHTML = `
    <input type="text" placeholder="Nombre" class="new-ac-nom">
    <input type="text" placeholder="Apellido" class="new-ac-ape">
    <button onclick="this.parentElement.remove()" style="background:#fee2e2; color:red; border:none; padding:0 8px;">‚úï</button>
  `;
  document.getElementById('new-al-acomp-container').appendChild(div);
}

async function guardarNuevoAlumno() {
  const instId = document.getElementById('new-al-inst').value;
  const nom = document.getElementById('new-al-nom').value;
  const ape = document.getElementById('new-al-ape').value;
  
  if(!instId || !nom || !ape) return alert('Completa los campos obligatorios');

  // 1. Insertar Alumno
  const { data: al, error } = await supabase.from('alumnos').insert([{nombre:nom, apellido:ape, institucion_id:instId}]).select().single();
  if(error) return alert('Error guardando alumno: ' + error.message);

  const alumnoId = al.id;

  // 2. Insertar Acompa√±antes
  const noms = document.querySelectorAll('.new-ac-nom');
  const apes = document.querySelectorAll('.new-ac-ape');
  const acompInserts = [];
  for(let i=0; i<noms.length; i++) {
    if(noms[i].value) acompInserts.push({nombre:noms[i].value, apellido:apes[i].value, alumno_id:alumnoId});
  }
  if(acompInserts.length) await supabase.from('acompanantes').insert(acompInserts);

  // 3. Insertar Mesas
  const checks = document.querySelectorAll('#new-al-mesas input:checked');
  if(checks.length) {
    const mesaInserts = Array.from(checks).map(c => ({alumno_id:alumnoId, mesa_id: c.value}));
    await supabase.from('alumno_mesas').insert(mesaInserts);
  }

  closeModal('modal-nuevo');
  cargarDatos();
  alert('Alumno registrado correctamente');
}

// --- MODAL EDITAR ---
function abrirModalEditar(id) {
  const al = dataGlobal.find(d => d.id === id);
  if(!al) return;
  document.getElementById('edit-id').value = id;
  document.getElementById('edit-nom').value = al.nombre;
  document.getElementById('edit-ape').value = al.apellido;

  const divMesas = document.getElementById('edit-mesas-container');
  divMesas.innerHTML = '';
  const asignadas = al.alumno_mesas.map(m => m.mesa.id);
  mesasGlobal.forEach(m => {
    const checked = asignadas.includes(m.id) ? 'checked' : '';
    divMesas.innerHTML += `<label style="display:flex;gap:5px;align-items:center;font-size:0.9rem;"><input type="checkbox" value="${m.id}" ${checked}> ${m.nombre}</label>`;
  });

  const divAcomp = document.getElementById('edit-acomp-container');
  divAcomp.innerHTML = '';
  // Existentes
  al.acompanantes.forEach(a => {
    divAcomp.innerHTML += `
      <div style="display:flex; gap:5px; margin-bottom:5px;">
        <input type="hidden" class="edit-old-id" value="${a.id}">
        <input type="text" class="edit-old-nom" value="${a.nombre}">
        <input type="text" class="edit-old-ape" value="${a.apellido}">
      </div>`;
  });

  document.getElementById('modal-editar').classList.add('active');
}

function agregarFilaAcompEditar() {
  const div = document.createElement('div');
  div.style.display = 'flex'; div.style.gap = '5px'; div.style.marginBottom = '5px';
  div.innerHTML = `
    <input type="text" placeholder="Nuevo Nombre" class="edit-new-nom">
    <input type="text" placeholder="Nuevo Apellido" class="edit-new-ape">
    <button onclick="this.parentElement.remove()" style="background:#fee2e2; color:red; border:none;">‚úï</button>
  `;
  document.getElementById('edit-acomp-container').appendChild(div);
}

async function guardarEdicion() {
  const id = document.getElementById('edit-id').value;
  const nom = document.getElementById('edit-nom').value;
  const ape = document.getElementById('edit-ape').value;

  // Update Alumno
  await supabase.from('alumnos').update({nombre:nom, apellido:ape}).eq('id',id);

  // Update Acompa√±antes Existentes
  const ids = document.querySelectorAll('.edit-old-id');
  const oldNoms = document.querySelectorAll('.edit-old-nom');
  const oldApes = document.querySelectorAll('.edit-old-ape');
  for(let i=0; i<ids.length; i++) {
    await supabase.from('acompanantes').update({nombre:oldNoms[i].value, apellido:oldApes[i].value}).eq('id', ids[i].value);
  }

  // Insertar Nuevos Acompa√±antes (agregados en edit)
  const newNoms = document.querySelectorAll('.edit-new-nom');
  const newApes = document.querySelectorAll('.edit-new-ape');
  const newInserts = [];
  for(let i=0; i<newNoms.length; i++) {
    if(newNoms[i].value) newInserts.push({nombre:newNoms[i].value, apellido:newApes[i].value, alumno_id:id});
  }
  if(newInserts.length) await supabase.from('acompanantes').insert(newInserts);

  // Update Mesas
  const checks = document.querySelectorAll('#edit-mesas-container input:checked');
  await supabase.from('alumno_mesas').delete().eq('alumno_id', id);
  if(checks.length > 0) {
    const inserts = Array.from(checks).map(c => ({alumno_id:id, mesa_id: c.value}));
    await supabase.from('alumno_mesas').insert(inserts);
  }

  closeModal('modal-editar');
  cargarDatos();
  alert('Guardado');
}

function closeModal(id) { document.getElementById(id).classList.remove('active'); }

// Agregado rapido
async function addLocal() { const n = document.getElementById('new-local').value; if(n){ await supabase.from('locales').insert([{nombre:n}]); cargarLocales(); alert('Local creado'); }}
async function addMesa() { const n = document.getElementById('new-mesa').value; if(n){ await supabase.from('mesas').insert([{nombre:n}]); cargarMesas(); alert('Mesa creada'); }}
async function addInst() { const l = selLocal.value; const n = document.getElementById('new-inst').value; if(l&&n){ await supabase.from('instituciones_educativas').insert([{nombre:n, local_id:l}]); alert('Instituci√≥n creada'); } else alert('Selecciona Local en filtro'); }
</script>
</body>
</html>