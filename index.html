<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Registro de Evento - Comit√©</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #2563eb;
      --primary-dark: #1e40af;
      --bg-color: #f8fafc;
      --card-bg: #ffffff;
      --text-main: #0f172a;
      --text-light: #64748b;
      --border: #e2e8f0;
      --success: #10b981;
      --danger: #ef4444;
    }

    * { box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-main);
      margin: 0;
      padding: 2rem 1rem;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .main-card {
      background: var(--card-bg);
      width: 100%;
      max-width: 800px;
      border-radius: 16px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      padding: 2rem;
    }

    h1 { margin: 0 0 0.5rem 0; text-align: center; color: var(--primary); }
    p.subtitle { text-align: center; color: var(--text-light); margin-bottom: 2rem; }

    /* Formularios */
    .form-group { margin-bottom: 1.5rem; }
    label { display: block; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem; }
    input, select {
      width: 100%; padding: 0.75rem; border: 1px solid var(--border);
      border-radius: 8px; font-size: 1rem; outline: none; transition: all 0.2s;
    }
    input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }

    .row-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }

    /* Botones */
    .btn {
      width: 100%; padding: 0.75rem; border: none; border-radius: 8px;
      font-weight: 600; cursor: pointer; transition: 0.2s; font-size: 1rem;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-success { background: var(--success); color: white; }
    .btn-secondary { background: #f1f5f9; color: var(--text-main); width: auto; padding: 0.5rem 1rem; font-size: 0.9rem;}
    .btn-danger { background: #fee2e2; color: var(--danger); padding: 0.4rem 0.8rem; font-size: 0.8rem;}

    /* TARJETA DE ALUMNO - ESTILO JER√ÅRQUICO */
    .alumno-card {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      background: white;
      position: relative;
      border-left: 5px solid var(--primary); /* L√≠nea visual izquierda */
    }
    
    .alumno-header {
      font-weight: 700; color: var(--primary); margin-bottom: 1rem;
      text-transform: uppercase; font-size: 0.85rem; letter-spacing: 1px;
    }

    /* SECCI√ìN ACOMPA√ëANTES (JERARQU√çA) */
    .acompanantes-section {
      margin-top: 1.2rem;
      padding-left: 1.5rem; /* Indentaci√≥n */
      border-left: 2px dashed #cbd5e1; /* L√≠nea gu√≠a punteada vertical */
      margin-left: 0.5rem;
    }
    
    .acomp-title {
      font-size: 0.85rem; font-weight: bold; color: var(--text-light);
      margin-bottom: 0.8rem; display: flex; align-items: center;
    }
    .acomp-title::before {
      content: "‚Ü≥"; /* S√≠mbolo de jerarqu√≠a */
      margin-right: 6px; font-size: 1.2rem; color: #cbd5e1;
    }

    .acomp-row {
      display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;
      position: relative;
    }
    /* Guion visual para cada item */
    .acomp-row::before {
      content: "-";
      position: absolute; left: -15px; color: var(--text-light); font-weight: bold;
    }

    .acomp-row input { padding: 0.5rem; font-size: 0.9rem; background: #f8fafc; }

    /* Utilidades */
    .hidden { display: none; }
    #message { margin-top: 1rem; text-align: center; padding: 0.8rem; border-radius: 6px; font-weight: 600; }
    .msg-error { background: #fef2f2; color: var(--danger); border: 1px solid #fecaca; }
    .msg-success { background: #f0fdf4; color: #15803d; border: 1px solid #bbf7d0; }

    /* =========================================
       ESTILOS DE IMPRESI√ìN (VOUCHER JER√ÅRQUICO)
       ========================================= */
    #print-area { display: none; }

    @media print {
      body { background: white; padding: 0; }
      .main-card, .no-print { display: none !important; }
      #print-area {
        display: block; width: 100%; max-width: 400px; /* Ancho ticket */
        margin: 0 auto; font-family: 'Courier New', monospace;
        color: black; padding: 10px;
      }
      .ticket-header { text-align: center; border-bottom: 1px dashed #000; padding-bottom: 10px; margin-bottom: 15px; }
      .ticket-header h2 { font-size: 1.2rem; margin: 5px 0; }
      .ticket-info p { margin: 3px 0; font-size: 0.9rem; }
      
      /* Lista Jer√°rquica en Impresi√≥n */
      .print-list { width: 100%; border-top: 1px solid #000; margin-top: 10px; padding-top: 10px; }
      
      .print-item-alumno {
        margin-top: 15px;
        font-weight: bold;
        font-size: 1rem;
        text-transform: uppercase;
      }
      
      .print-item-acomp {
        margin-left: 20px; /* Sangr√≠a para acompa√±ante */
        font-size: 0.9rem;
        margin-top: 2px;
        font-weight: normal;
        text-transform: capitalize;
      }
      .print-item-acomp::before {
        content: "- "; /* Guion forzado */
      }

      .ticket-total { margin-top: 20px; border-top: 1px dashed #000; padding-top: 10px; text-align: right; font-weight: bold; }
      .ticket-footer { margin-top: 30px; text-align: center; font-size: 0.8rem; }
    }
  </style>
</head>
<body>

  <div class="main-card">
    <h1>Registro de Ingreso</h1>
    <p class="subtitle">Sistema de Control</p>

    <div id="pantalla1">
      <div class="form-group">
        <label>Local</label>
        <select id="local-select"><option value="">Cargando...</option></select>
      </div>
      <div class="form-group">
        <label>Instituci√≥n Educativa</label>
        <div class="row-grid">
          <select id="institucion-select" class="hidden"></select>
          <input type="text" id="institucion-input" placeholder="Nombre de la instituci√≥n">
        </div>
      </div>
      <div class="form-group">
        <label>Cantidad de Alumnos</label>
        <input type="number" id="numero-alumnos" min="1" value="1">
      </div>
      <button id="btn-siguiente" class="btn btn-primary">Siguiente</button>
    </div>

    <div id="pantalla2" class="hidden">
      <div style="display:flex; justify-content:space-between; margin-bottom:1rem;">
        <h3 style="margin:0;">Datos de Asistentes</h3>
        <button id="btn-volver" class="btn btn-secondary">Atr√°s</button>
      </div>
      
      <div id="alumnos-container"></div>
      
      <div id="message"></div>
      
      <button id="btn-guardar" class="btn btn-success" style="margin-top:1.5rem;">Guardar Registro</button>
    </div>

    <div id="pantalla3" class="hidden" style="text-align:center;">
      <h2 style="color:var(--success);">¬°Registro Exitoso!</h2>
      <p>Se ha bloqueado la instituci√≥n para evitar duplicados.</p>
      <button onclick="window.print()" class="btn btn-primary">üñ®Ô∏è Imprimir Ticket</button>
      <br><br>
      <button onclick="location.reload()" class="btn btn-secondary">Nuevo Registro (Reiniciar)</button>
    </div>
  </div>

  <div id="print-area">
    <div class="ticket-header">
      <h2>TICKET DE INGRESO</h2>
      <p id="print-fecha"></p>
    </div>
    <div class="ticket-info">
      <p><strong>Local:</strong> <span id="print-local"></span></p>
      <p><strong>Instituci√≥n:</strong> <span id="print-institucion"></span></p>
      <p><strong>C√≥digo:</strong> <span id="print-id"></span></p>
    </div>

    <div id="print-lista" class="print-list"></div>

    <div class="ticket-total">
      TOTAL PERSONAS: <span id="print-total">0</span>
    </div>
    
    <div class="ticket-footer">
      <p>_______________________<br>Firma Conformidad</p>
    </div>
  </div>

<script>
  const SUPABASE_URL = 'https://zygyagsmkjgvtmoxoznk.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp5Z3lhZ3Nta2pndnRtb3hvem5rIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM0ODk3OTMsImV4cCI6MjA3OTA2NTc5M30.ZQ2ihigMNlbR5DtWcaiOxDUYdImkd7Af-xcpjHV8LnY';
  const { createClient } = window.supabase;
  const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Elementos
  const localSelect = document.getElementById('local-select');
  const instSelect = document.getElementById('institucion-select');
  const instInput = document.getElementById('institucion-input');
  const container = document.getElementById('alumnos-container');
  const msg = document.getElementById('message');

  let alumnosData = [];
  let sesion = {};

  // 1. Carga Inicial
  async function cargarLocales() {
    const { data } = await supabase.from('locales').select('*').order('nombre');
    localSelect.innerHTML = '<option value="">-- Selecciona --</option>';
    data?.forEach(l => localSelect.innerHTML += `<option value="${l.id}">${l.nombre}</option>`);
  }
  cargarLocales();

  localSelect.addEventListener('change', async () => {
    instSelect.classList.add('hidden');
    instInput.style.display = 'block';
    instInput.value = '';
    if(!localSelect.value) return;
    
    const { data } = await supabase.from('instituciones_educativas')
      .select('*').eq('local_id', localSelect.value).order('nombre');
    
    if(data.length > 0){
      instSelect.classList.remove('hidden');
      instInput.style.display = 'none';
      instSelect.innerHTML = '<option value="">-- Selecciona --</option><option value="nueva">+ Nueva...</option>';
      data.forEach(i => instSelect.innerHTML += `<option value="${i.id}">${i.nombre}</option>`);
    }
  });

  instSelect.addEventListener('change', () => {
    instInput.style.display = (instSelect.value === 'nueva') ? 'block' : 'none';
    if(instSelect.value === 'nueva') instInput.focus();
  });

  // 2. Navegaci√≥n
  document.getElementById('btn-siguiente').addEventListener('click', () => {
    const cant = parseInt(document.getElementById('numero-alumnos').value);
    if(!localSelect.value) return alert('Selecciona local');
    if(cant < 1) return alert('M√≠nimo 1 alumno');
    
    sesion = {
      localId: localSelect.value,
      instId: (instSelect.value && instSelect.value !== 'nueva') ? instSelect.value : null,
      instNombre: instInput.value || instSelect.options[instSelect.selectedIndex].text,
      cantidad: cant
    };
    
    renderFormulario(cant);
    document.getElementById('pantalla1').classList.add('hidden');
    document.getElementById('pantalla2').classList.remove('hidden');
  });

  document.getElementById('btn-volver').addEventListener('click', () => {
    document.getElementById('pantalla2').classList.add('hidden');
    document.getElementById('pantalla1').classList.remove('hidden');
  });

  // 3. Renderizado con Dise√±o Jer√°rquico
  function renderFormulario(n) {
    container.innerHTML = '';
    alumnosData = [];
    for(let i=0; i<n; i++){
      alumnosData.push({ nombre: '', apellido: '', acompanantes: [] });
      
      const div = document.createElement('div');
      div.className = 'alumno-card';
      div.innerHTML = `
        <div class="alumno-header">Alumno #${i+1} (Principal)</div>
        <div class="row-grid">
          <input type="text" placeholder="Nombre Alumno" oninput="updAlumno(${i}, 'nombre', this.value)">
          <input type="text" placeholder="Apellido Alumno" oninput="updAlumno(${i}, 'apellido', this.value)">
        </div>
        
        <div class="acompanantes-section">
          <div class="acomp-title">Acompa√±antes (Dependientes)</div>
          <div id="list-acomp-${i}"></div>
          <button class="btn btn-secondary" style="font-size:0.8rem; margin-top:5px;" onclick="addAcomp(${i})">+ Agregar Acompa√±ante</button>
        </div>
      `;
      container.appendChild(div);
    }
  }

  window.updAlumno = (i, field, val) => alumnosData[i][field] = val;

  window.addAcomp = (i) => {
    const idxAcomp = alumnosData[i].acompanantes.length;
    alumnosData[i].acompanantes.push({ nombre:'', apellido:'' });
    
    const row = document.createElement('div');
    row.className = 'acomp-row';
    row.innerHTML = `
      <input type="text" placeholder="Nombre" oninput="updAcomp(${i}, ${idxAcomp}, 'nombre', this.value)">
      <input type="text" placeholder="Apellido" oninput="updAcomp(${i}, ${idxAcomp}, 'apellido', this.value)">
      <button class="btn btn-danger" onclick="this.parentElement.remove(); delAcomp(${i}, ${idxAcomp})">X</button>
    `;
    document.getElementById(`list-acomp-${i}`).appendChild(row);
  };

  window.updAcomp = (i, j, field, val) => {
    if(alumnosData[i].acompanantes[j]) alumnosData[i].acompanantes[j][field] = val;
  };
  
  window.delAcomp = (i, j) => {
    // Marcamos como null para filtrar al guardar
    alumnosData[i].acompanantes[j] = null;
  };

  // 4. Guardado con Validaci√≥n de Duplicados
  document.getElementById('btn-guardar').addEventListener('click', async () => {
    const btn = document.getElementById('btn-guardar');
    msg.textContent = '';
    msg.className = '';

    // Validar campos vac√≠os
    if(alumnosData.some(a => !a.nombre || !a.apellido)) {
      msg.textContent = 'Todos los alumnos deben tener nombre y apellido.';
      msg.className = 'msg-error';
      return;
    }

    btn.disabled = true;
    btn.textContent = 'Verificando...';

    try {
      // A. Resolver ID de Instituci√≥n
      let finalInstId = sesion.instId;
      if(!finalInstId) {
        // Buscar si existe por nombre
        const { data: existe } = await supabase.from('instituciones_educativas')
          .select('id').ilike('nombre', sesion.instNombre.trim()).maybeSingle();
        
        if(existe) finalInstId = existe.id;
        else {
          const { data: nueva } = await supabase.from('instituciones_educativas')
            .insert([{ nombre: sesion.instNombre.trim(), local_id: sesion.localId }]).select().single();
          finalInstId = nueva.id;
        }
      }

      // B. VERIFICACI√ìN DE DUPLICADOS (Crucial)
      const { data: duplicado } = await supabase.from('registros_comite')
        .select('id')
        .eq('institucion_id', finalInstId)
        .maybeSingle();

      if (duplicado) {
        throw new Error('¬°ALERTA! Esta instituci√≥n YA FUE REGISTRADA anteriormente. No se puede volver a ingresar.');
      }

      // C. Guardar Datos
      btn.textContent = 'Guardando...';
      
      const { data: reg } = await supabase.from('registros_comite')
        .insert([{ local_id: sesion.localId, institucion_id: finalInstId, numero_alumnos: sesion.cantidad }])
        .select().single();

      for(const alum of alumnosData) {
        const { data: alumDb } = await supabase.from('alumnos')
          .insert([{ nombre: alum.nombre, apellido: alum.apellido, institucion_id: finalInstId }])
          .select().single();
          
        await supabase.from('registro_alumnos').insert([{ registro_comite_id: reg.id, alumno_id: alumDb.id }]);

        const validAcomps = alum.acompanantes.filter(a => a !== null && a.nombre);
        if(validAcomps.length > 0) {
          await supabase.from('acompanantes').insert(
            validAcomps.map(a => ({ nombre: a.nombre, apellido: a.apellido, alumno_id: alumDb.id }))
          );
        }
      }

      // D. Preparar Ticket Jer√°rquico
      prepararTicket(finalInstId, reg.id);
      document.getElementById('pantalla2').classList.add('hidden');
      document.getElementById('pantalla3').classList.remove('hidden');

    } catch (e) {
      msg.textContent = e.message;
      msg.className = 'msg-error';
      btn.disabled = false;
      btn.textContent = 'Guardar Registro';
    }
  });

  function prepararTicket(instId, regId) {
    // Datos cabecera
    document.getElementById('print-fecha').textContent = new Date().toLocaleString();
    document.getElementById('print-local').textContent = localSelect.options[localSelect.selectedIndex].text;
    document.getElementById('print-institucion').textContent = sesion.instNombre;
    document.getElementById('print-id').textContent = '#' + regId;

    // Generar Lista Jer√°rquica
    const listaDiv = document.getElementById('print-lista');
    listaDiv.innerHTML = '';
    let total = 0;

    alumnosData.forEach(alum => {
      total++;
      // 1. Alumno (Padre)
      const divAlum = document.createElement('div');
      divAlum.className = 'print-item-alumno';
      divAlum.textContent = `‚Ä¢ ${alum.nombre} ${alum.apellido}`;
      listaDiv.appendChild(divAlum);

      // 2. Acompa√±antes (Hijos con guiones)
      const acomps = alum.acompanantes.filter(a => a!==null && a.nombre);
      acomps.forEach(ac => {
        total++;
        const divAc = document.createElement('div');
        divAc.className = 'print-item-acomp';
        divAc.textContent = `${ac.nombre} ${ac.apellido}`; // El CSS agrega el guion "- "
        listaDiv.appendChild(divAc);
      });
    });

    document.getElementById('print-total').textContent = total;
  }
</script>
</body>
</html>